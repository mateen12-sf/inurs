
// --- Design Constants ---
const PRIMARY_COLOR = 'bg-teal-700';
const VIEW_CONFIG = {
  qa: { textKey: 'tab_qa', icon: 'ğŸ’¬', button: 'bg-sky-500 hover:bg-sky-600' },
  drug: { textKey: 'tab_drug', icon: 'ğŸ’Š', button: 'bg-emerald-500 hover:bg-emerald-600' },
  lab: { textKey: 'tab_lab', icon: 'ğŸ”¬', button: 'bg-indigo-500 hover:bg-indigo-600' },
  pregnancy: { textKey: 'tab_pregnancy', icon: 'ğŸ¤°', button: 'bg-amber-500 hover:bg-amber-600' },
  doctors: { textKey: 'tab_doctors', icon: 'ğŸ‘¨â€âš•ï¸', button: 'bg-rose-500 hover:bg-rose-600' },
  donation: { textKey: 'tab_donation', icon: 'â¤ï¸', button: 'bg-red-500 hover:bg-red-600' },
};

const UI_TEXT = {
  ku: {
    app_title: "iDoctors",
    tab_qa: "Ú¯ÙØªÙˆÚ¯Û† (AI)",
    tab_drug: "Ø¯Û•Ø±Ù…Ø§Ù†",
    tab_lab: "ÙÛ•Ø­Ø³ (AI)",
    tab_pregnancy: "Ø¯ÙˆÙˆÚ¯ÛŒØ§Ù†ÛŒ",
    tab_doctors: "Ø¯Ú©ØªÛ†Ø±Û•Ú©Ø§Ù†",
    tab_donation: "Ø¨Û•Ø®Ø´ÛŒÙ†",
    drug_search_title: "Ù†Ø§ÙˆÛŒ Ø¯Û•Ø±Ù…Ø§Ù†Û•Ú©Ø§Ù†",
    drug_pharmacy_title: "Ù†Ø§ÙˆÙ†ÛŒØ´Ø§Ù†ÛŒ Ø¯Û•Ø±Ù…Ø§Ù†Ø®Ø§Ù†Û•Ú©Ø§Ù†",
    drug_rx_title: "Ø®ÙˆÛÙ†Ø¯Ù†Û•ÙˆÛ•ÛŒ Ú•Û•Ú†Û•ØªÛ•",
    lab_analyze_title: "Ø®ÙˆÛÙ†Ø¯Ù†Û•ÙˆÛ•ÛŒ ÙÛ•Ø­Ø³ (AI)",
    lab_prompt: "ÙˆÛÙ†Û•ÛŒ ÙÛ•Ø­Ø³Û•Ú©Û• Ù„ÛØ±Û• Ø¯Ø§Ø¨Ù†Û Ø¨Û† Ø´ÛŒÚ©Ø±Ø¯Ù†Û•ÙˆÛ•ÛŒ ØªÛ•ÙˆØ§Ùˆ",
    lab_address_title: "Ù†Ø§ÙˆÙ†ÛŒØ´Ø§Ù†ÛŒ ØªØ§Ù‚ÛŒÚ¯Û•Ú©Ø§Ù†",
    lab_address_status: "Ù†Ø§ÙˆÙ†ÛŒØ´Ø§Ù†ÛŒ Ù‡Û•Ø±Ø²Ø§Ù†ØªØ±ÛŒÙ† ØªØ§Ù‚ÛŒÚ¯Û•ÛŒÛ•Ú©Ø§Ù† Ø¨Û•Ù… Ø²ÙˆØ§Ù†Û• Ø¨Û•Ø±Ø¯Û•Ø³Øª Ø¯Û•Ø¨ÛŒØª",
    preg_weeks_title: "Ù‡Û•ÙØªÛ•Ú©Ø§Ù†ÛŒ Ø¯ÙˆÙˆÚ¯ÛŒØ§Ù†ÛŒ (AI)",
    preg_gender_title: "Ø¯ÛŒØ§Ø±ÛŒÚ©Ø±Ø¯Ù†ÛŒ Ú•Û•Ú¯Û•Ø² (AI)",
    preg_date_placeholder: "Ú•ÛÚ©Û•ÙˆØªÛŒ Ú©Û†ØªØ§ Ø³ÙˆÙˆÚ•ÛŒ Ù…Ø§Ù†Ú¯Ø§Ù†Û• Ù‡Û•ÚµØ¨Ú˜ÛØ±Û•",
    preg_weeks_btn: "Ù‡Û•Ú˜Ù…Ø§Ø±Ú©Ø±Ø¯Ù†ÛŒ Ù‡Û•ÙØªÛ•Ú©Ø§Ù† Ùˆ Ø²Ø§Ù†ÛŒØ§Ø±ÛŒ",
    preg_gender_btn: "Ú©Ø§ØªÛ•Ú©Ø§Ù†ÛŒ Ø¯ÛŒØ§Ø±ÛŒÚ©Ø±Ø¯Ù†ÛŒ Ú•Û•Ú¯Û•Ø²",
    docs_search_title: "Ú¯Û•Ú•Ø§Ù† Ø¨Û•Ø¯ÙˆØ§ÛŒ Ø¯Ú©ØªÛ†Ø±",
    docs_placeholder: "Ù†Ø§ÙˆÛŒ Ø¯Ú©ØªÛ†Ø± ÛŒØ§Ù† Ù¾Ø³Ù¾Û†Ú•ÛŒ Ø¨Ù†ÙˆÙˆØ³Û•...",
    docs_btn: "Ú¯Û•Ú•Ø§Ù† Ø¨Û† Ù¾Ø²ÛŒØ´Ú© âœ¨",
    docs_online_title: "Ø¯Ú©ØªÛ†Ø±ÛŒ Ø¦Û†Ù†Ù„Ø§ÛŒÙ† (AI)",
    docs_booking_title: "Ù†Û†Ø±Û•Ú¯Ø±ØªÙ†",
    docs_booking_status: "Ø¨Û• Ø²ÙˆÙˆØªØ±ÛŒÙ† Ú©Ø§Øª Ø¨Û•Ø±Ø¯Û•Ø³Øª Ø¯Û•Ø¨ÛØª",
    placeholder_drug: "Ù†Ø§ÙˆÛŒ Ø¯Û•Ø±Ù…Ø§Ù†Û•Ú©Û• Ù„ÛØ±Û• Ø¨Ù†ÙˆÙˆØ³Û•...",
    pharmacy_status: "Ù†Ø§ÙˆÙ†ÛŒØ´Ø§Ù†ÛŒ Ù‡Û•Ø±Ø²Ø§Ù†ØªØ±ÛŒÙ† Ø¯Û•Ø±Ù…Ø§Ù†Ø®Ø§Ù†Û•Ú©Ø§Ù† Ø¨Û•Ù… Ø²ÙˆÙˆØ§Ù†Û• Ø¨Û•Ø±Ø¯Û•Ø³Øª Ø¯Û•Ø¨ÛØª...",
    rx_prompt: "ÙˆÛÙ†Û•ÛŒ Ú•Û•Ú†Û•ØªÛ•Ú©Û• Ù„ÛØ±Û• Ø¯Ø§Ø¨Ù†Û",
    loading: "ØªÚ©Ø§ÛŒÛ• Ú†Ø§ÙˆÛ•Ú•Û Ø¨Û•...",
    error: "Ù‡Û•ÚµÛ•ÛŒÛ•Ú© Ú•ÙˆÙˆÛŒØ¯Ø§ Ù„Û• Ù¾Û•ÛŒÙˆÛ•Ù†Ø¯ÛŒ Ú©Ø±Ø¯Ù†.",
    disclaimer: "ØªÛØ¨ÛŒÙ†ÛŒ: Ø¦Û•Ù… Ø¦Û•Ù¾Ù„ÛŒÚ©Û•ÛŒØ´Ù†Û• ØªÛ•Ù†Ù‡Ø§ Ø¨Û† Ø²Ø§Ù†ÛŒØ§Ø±ÛŒÛŒÛ• Ùˆ Ø¬ÛÚ¯Ø±Û•ÙˆÛ•ÛŒ Ú•Ø§ÙˆÛÚ˜ÛŒ Ù¾Ø²ÛŒØ´Ú©ÛŒ Ù†ÛŒÛŒÛ•.",
    visitor_count_label: "Ú˜Ù…Ø§Ø±Û•ÛŒ Ø³Û•Ø±Ø¯Ø§Ù†ÛŒÚ©Û•Ø±Ø§Ù†:",
  },
  ar: {
    app_title: "iDoctors",
    tab_qa: "Ø¯Ø±Ø¯Ø´Ø© (AI)",
    tab_drug: "Ø§Ù„Ø£Ø¯ÙˆÙŠØ©",
    tab_lab: "Ø§Ù„ØªØ­Ø§Ù„ÙŠÙ„ (AI)",
    tab_pregnancy: "Ø§Ù„Ø­Ù…Ù„",
    tab_doctors: "Ø§Ù„Ø£Ø·Ø¨Ø§Ø¡",
    tab_donation: "Ø§Ù„ØªØ¨Ø±Ø¹",
    drug_search_title: "Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ø£Ø¯ÙˆÙŠØ©",
    drug_pharmacy_title: "Ø¹Ù†Ø§ÙˆÙŠÙ† Ø§Ù„ØµÙŠØ¯Ù„ÙŠØ§Øª",
    drug_rx_title: "Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø±ÙˆØ´ØªØ©",
    lab_analyze_title: "Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„ØªØ­Ù„ÙŠÙ„ (AI)",
    lab_prompt: "Ø¶Ø¹ ØµÙˆØ±Ø© Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ù‡Ù†Ø§ Ù„Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„ÙƒØ§Ù…Ù„",
    lab_address_title: "Ø¹Ù†Ø§ÙˆÙŠÙ† Ø§Ù„Ù…Ø®ØªØ¨Ø±Ø§Øª",
    lab_address_status: "Ø¹Ù†Ø§ÙˆÙŠÙ† Ø£Ø±Ø®Øµ Ø§Ù„Ù…Ø®ØªØ¨Ø±Ø§Øª Ø³ØªØªÙˆÙØ± Ù‚Ø±ÙŠØ¨Ø§Ù‹",
    preg_weeks_title: "Ø£Ø³Ø§Ø¨ÙŠØ¹ Ø§Ù„Ø­Ù…Ù„ (AI)",
    preg_gender_title: "ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø¬Ù†Ø³ (AI)",
    preg_date_placeholder: "Ø§Ø®ØªØ± ØªØ§Ø±ÙŠØ® Ø¢Ø®Ø± Ø¯ÙˆØ±Ø© Ø´Ù‡Ø±ÙŠØ©",
    preg_weeks_btn: "Ø­Ø³Ø§Ø¨ Ø§Ù„Ø£Ø³Ø§Ø¨ÙŠØ¹ ÙˆØ§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª",
    preg_gender_btn: "Ø£ÙˆÙ‚Ø§Øª ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø¬Ù†Ø³",
    docs_search_title: "Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø·Ø¨ÙŠØ¨",
    docs_placeholder: "Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ø·Ø¨ÙŠØ¨ Ø£Ùˆ Ø§Ù„Ø§Ø®ØªØµØ§Øµ...",
    docs_btn: "Ø¨Ø­Ø« Ø¹Ù† Ø·Ø¨ÙŠØ¨ âœ¨",
    docs_online_title: "Ø·Ø¨ÙŠØ¨ Ø£ÙˆÙ†Ù„Ø§ÙŠÙ† (AI)",
    docs_booking_title: "Ø§Ù„Ø­Ø¬Ø²",
    docs_booking_status: "Ø³ÙŠØªÙˆÙØ± ÙÙŠ Ø£Ù‚Ø±Ø¨ ÙˆÙ‚Øª Ù…Ù…ÙƒÙ†",
    placeholder_drug: "Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ø¯ÙˆØ§Ø¡ Ù‡Ù†Ø§...",
    pharmacy_status: "Ø¹Ù†Ø§ÙˆÙŠÙ† Ø£Ø±Ø®Øµ Ø§Ù„ØµÙŠØ¯Ù„ÙŠØ§Øª Ø³ØªØªÙˆÙØ± Ù‚Ø±ÙŠØ¨Ø§Ù‹...",
    rx_prompt: "Ø¶Ø¹ ØµÙˆØ±Ø© Ø§Ù„Ø±ÙˆØ´ØªØ© Ù‡Ù†Ø§",
    loading: "ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±...",
    error: "Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„.",
    disclaimer: "Ù…Ù„Ø§Ø­Ø¸Ø©: Ù‡Ø°Ø§ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ù„Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª ÙÙ‚Ø· ÙˆÙ„ÙŠØ³ Ø¨Ø¯ÙŠÙ„Ø§Ù‹ Ø¹Ù† Ø§Ù„Ø§Ø³ØªØ´Ø§Ø±Ø© Ø§Ù„Ø·Ø¨ÙŠØ©.",
    visitor_count_label: "Ø¹Ø¯Ø¯ Ø§Ù„Ø²ÙˆØ§Ø±:",
  },
  en: {
    app_title: "iDoctors",
    tab_qa: "Chat (AI)",
    tab_drug: "Medicine",
    tab_lab: "Lab Test (AI)",
    tab_pregnancy: "Pregnancy",
    tab_doctors: "Doctors",
    tab_donation: "Donation",
    drug_search_title: "Medicine Names",
    drug_pharmacy_title: "Pharmacy Addresses",
    drug_rx_title: "Read Prescription",
    lab_analyze_title: "Analyze Lab (AI)",
    lab_prompt: "Drop lab image here for full analysis",
    lab_address_title: "Lab Addresses",
    lab_address_status: "Cheapest lab addresses will be available soon",
    preg_weeks_title: "Pregnancy Weeks (AI)",
    preg_gender_title: "Gender Detection (AI)",
    preg_date_placeholder: "Select last menstrual period date",
    preg_weeks_btn: "Calculate Weeks & Info",
    preg_gender_btn: "Gender Detection Times",
    docs_search_title: "Search for Doctor",
    docs_placeholder: "Enter doctor name or specialty...",
    docs_btn: "Search for Doctor âœ¨",
    docs_online_title: "Online Doctor (AI)",
    docs_booking_title: "Booking",
    docs_booking_status: "Will be available soon",
    placeholder_drug: "Enter medicine name here...",
    pharmacy_status: "Cheapest pharmacy addresses will be available soon...",
    rx_prompt: "Drop prescription image here",
    loading: "Please wait...",
    error: "A connection error occurred.",
    disclaimer: "Note: This app is for information only and not a substitute for medical advice.",
    visitor_count_label: "Visitor Count:",
  }
};

const arrayBufferToBase64 = (buffer) => {
  let binary = '';
  const bytes = new Uint8Array(buffer);
  for (let i = 0; i < bytes.byteLength; i++) binary += String.fromCharCode(bytes[i]);
  return btoa(binary);
};

export default function App() {
  const [currentView, setCurrentView] = useState('qa');
  const [language, setLanguage] = useState('ku');
  const [query, setQuery] = useState('');
  const [response, setResponse] = useState(null);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState(null);
  const [imageData, setImageData] = useState(null);
  const [visitorCount, setVisitorCount] = useState(0);
  const [chatHistory, setChatHistory] = useState([]);

  const t = (k) => (UI_TEXT[language] && UI_TEXT[language][k]) || k;

  useEffect(() => {
    const initFirebase = async () => {
      try {
        if (typeof __firebase_config === 'undefined') return;
        const config = JSON.parse(__firebase_config);
        if (!config.apiKey) return;
        const app = getApps().length === 0 ? initializeApp(config) : getApps()[0];
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'idoctore-app';

        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
          await signInWithCustomToken(auth, __initial_auth_token);
        } else {
          await signInAnonymously(auth);
        }

        onAuthStateChanged(auth, (u) => {
          if (u) {
            const docRef = doc(db, "artifacts", appId, "public", "data", "app_metrics", "visitor_count");
            onSnapshot(docRef, (s) => setVisitorCount(s.exists() ? s.data().count : 0));
            const key = `visited_${new Date().toDateString()}`;
            if (!localStorage.getItem(key)) {
              setDoc(docRef, { count: increment(1) }, { merge: true }).then(() => localStorage.setItem(key, 'true'));
            }
          }
        });
      } catch (e) { console.error(e); }
    };
    initFirebase();
  }, []);

  useEffect(() => {
    if (currentView === 'doctors' && chatHistory.length === 0) {
      const startDoctorAI = async () => {
        setLoading(true);
        const systemPrompt = `You are a professional medical consultant at iDoctors. 
        Start the conversation by saying exactly: "Ø³ÚµØ§ÙˆØŒ Ù¾ÛÙˆÛŒØ³ØªÛŒØª Ø¨Û• Ú©Ø§Ù… Ø¯Ú©ØªÛ†Ø±Û•ØŸ" in Kurdish.
        Wait for their answer about the specialty. 
        In the second turn, ask for: (Ù†Ø§ÙˆÛŒ ØªÛ•ÙˆØ§ÙˆØŒ ØªÛ•Ù…Û•Ù†ØŒ Ø¦Ø§ÛŒØ§ Ù†Û•Ø®Û†Ø´ÛŒ Ø¯Ø±ÛÚ˜Ø®Ø§ÛŒÛ•Ù†Øª Ù‡Û•ÛŒÛ•ØŸ).
        After that, proceed like a real doctor asking clinical questions one by one until you reach a medical advice/treatment suggestion.
        Be polite and professional. Use Central Kurdish.`;

        const payload = {
          contents: [{ role: 'user', parts: [{ text: "Start the medical consultation flow." }] }],
          systemInstruction: { parts: [{ text: systemPrompt }] },
        };

        try {
          const res = await fetch(`${BASE_URL}${MODEL_NAME_FLASH}:generateContent?key=${API_KEY}`, {
            method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload)
          });
          const data = await res.json();
          const aiText = data.candidates?.[0]?.content?.parts?.[0]?.text || "Ø³ÚµØ§ÙˆØŒ Ú†Û†Ù† Ø¯Û•ØªÙˆØ§Ù†Ù… ÛŒØ§Ø±Ù…Û•ØªÛŒØª Ø¨Ø¯Û•Ù…ØŸ";
          setChatHistory([{ role: 'model', text: aiText }]);
        } catch (e) { console.error(e); } finally { setLoading(false); }
      };
      startDoctorAI();
    }
  }, [currentView]);

  const handleAIService = async (mode, customQuery = null) => {
    const activeQuery = customQuery || query;
    if (!activeQuery.trim() && !imageData) return;
    setLoading(true); setError(null); setResponse(null);
    
    let systemPrompt = `You are a professional medical assistant for iDoctors. Answer in ${language.toUpperCase()}.`;
    
    if (mode === 'drug') {
        systemPrompt += ` Focus: Drug Information. Provide: 1. Full Drug Name, 2. Uses, 3. Side effects, 4. Precautions.`;
    } else if (mode === 'drug_rx') {
        systemPrompt += ` Focus: Prescription Analysis. Read text from image, explain medications clearly.`;
    } else if (mode === 'lab') {
        systemPrompt += ` Analyze medical lab test results. 1. Name, 2. Result, 3. Comparison, 4. Advice.`;
    } else if (mode === 'doctors_ai') {
        systemPrompt = `You are a professional doctor. Flow: 1. Specialty, 2. Info (Name/Age/Chronic), 3. Diagnostic Qs, 4. Final advice. Language: KURDISH.`;
    } else if (mode === 'pregnancy_weeks') {
        systemPrompt = `You are a pregnancy expert. The user provides their Last Menstrual Period (LMP) date. Today is ${new Date().toISOString()}.
        Calculate the current week of pregnancy.
        Explain: 
        1. ØªÛ•Ù…Û•Ù†ÛŒ Ú©ÙˆØ±Ù¾Û• Ø¨Û• Ù‡Û•ÙØªÛ• Ùˆ Ù…Ø§Ù†Ú¯.
        2. Ú¯Û†Ú•Ø§Ù†Ú©Ø§Ø±ÛŒÛŒÛ•Ú©Ø§Ù†ÛŒ Ú©ÙˆØ±Ù¾Û• Ù„Û•Ù… Ù‡Û•ÙØªÛ•ÛŒÛ•Ø¯Ø§.
        3. Ø¯ÛŒØ§Ø±ÛŒÚ©Ø±Ø¯Ù†ÛŒ Ú•Û†Ú˜ÛŒ Ù„Û•Ø¯Ø§ÛŒÚ©Ø¨ÙˆÙˆÙ† (EDD).
        4. Ø¦Ø§Ù…Û†Ú˜Ú¯Ø§Ø±ÛŒ Ú¯Ø±Ù†Ú¯ Ø¨Û† Ø¯Ø§ÛŒÚ©Û•Ú©Û•.
        Answer in Central Kurdish. Be supportive and accurate.`;
    } else if (mode === 'pregnancy_gender') {
        systemPrompt = `You are a reproductive health expert. The user provides their Last Menstrual Period (LMP) date. 
        Based on biological cycles (like Shettles method or ovulation timing), provide:
        1. Ú©Ø§ØªÛŒ Ú¯ÙˆÙ†Ø¬Ø§Ùˆ Ø¨Û† Ø¬ÙˆÙˆØªØ¨ÙˆÙˆÙ† Ø¦Û•Ú¯Û•Ø± Ú•Û•Ú¯Û•Ø²ÛŒ Ú©Ú†ÛŒØ§Ù† Ø¨ÙˆÛØª (ØªØ§Ø±ÛŒØ®ÛŒ Ø¯Û•Ø³ØªÙ¾ÛÚ© Ùˆ Ú©Û†ØªØ§ÛŒÛŒ).
        2. Ú©Ø§ØªÛŒ Ú¯ÙˆÙ†Ø¬Ø§Ùˆ Ø¨Û† Ø¬ÙˆÙˆØªØ¨ÙˆÙˆÙ† Ø¦Û•Ú¯Û•Ø± Ú•Û•Ú¯Û•Ø²ÛŒ Ú©ÙˆØ±ÛŒØ§Ù† Ø¨ÙˆÛØª (ØªØ§Ø±ÛŒØ®ÛŒ Ø¯Û•Ø³ØªÙ¾ÛÚ© Ùˆ Ú©Û†ØªØ§ÛŒÛŒ).
        Explain the instructions clearly.
        Answer in Central Kurdish.`;
    } else if (mode === 'qa') {
        systemPrompt = `You are a general medical AI assistant. Answer the user query clearly in ${language.toUpperCase()}.`;
    } else if (mode === 'donation') {
        systemPrompt = `Provide information about blood/organ donation based on user query in ${language.toUpperCase()}.`;
    }

    const payload = {
        contents: mode === 'doctors_ai' 
            ? [...chatHistory.map(h => ({ role: h.role, parts: [{ text: h.text }] })), { role: 'user', parts: [{ text: activeQuery }] }]
            : [{ parts: [{ text: activeQuery || "Analyze this" }, ...(imageData ? [{ inlineData: imageData }] : [])] }],
        systemInstruction: { parts: [{ text: systemPrompt }] },
    };

    try {
      const res = await fetch(`${BASE_URL}${MODEL_NAME_FLASH}:generateContent?key=${API_KEY}`, {
        method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload)
      });
      const data = await res.json();
      const aiText = data.candidates?.[0]?.content?.parts?.[0]?.text || "No response.";
      
      if (mode === 'doctors_ai') {
          setChatHistory(prev => [...prev, { role: 'user', text: activeQuery }, { role: 'model', text: aiText }]);
          setQuery('');
      } else {
          setResponse(aiText);
      }
    } catch (e) { setError(t('error')); } finally { setLoading(false); }
  };

  const handleFile = (e) => {
    const file = e.target.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onload = () => setImageData({ data: arrayBufferToBase64(reader.result), mimeType: file.type });
      reader.readAsArrayBuffer(file);
    }
  };

  return (
    <div className="min-h-screen bg-gray-50 flex justify-center overflow-x-hidden" dir={language === 'en' ? 'ltr' : 'rtl'}>
      <style dangerouslySetInnerHTML={{__html: `
        input, textarea, select { font-size: 16px !important; }
        @viewport { width: device-width; zoom: 1.0; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
      `}} />

      <div className="w-full max-w-md shadow-2xl min-h-screen flex flex-col border-x border-gray-100 bg-white">
        
        {/* Header */}
        <header className={`${PRIMARY_COLOR} pt-10 pb-8 px-6 text-white rounded-b-[40px] shadow-lg relative overflow-hidden`}>
          {/* Subtle Background Glow */}
          <div className="absolute top-0 right-0 w-32 h-32 bg-white/10 rounded-full -mr-16 -mt-16 blur-3xl"></div>
          
          <div className="flex justify-between items-center relative z-10">
            <h1 className="text-xl font-black flex items-center gap-2">
              {/* Requested Custom Icon */}
              <div className="bg-white p-0.5 rounded-lg overflow-hidden flex items-center justify-center w-10 h-10 shadow-sm">
                <img src="https://i.ibb.co/nN9nYZ1q/IMG-1261.png" alt="iDoctors Logo" className="w-full h-full object-contain" />
              </div>
              {t('app_title')}
            </h1>
            
            {/* Language Switcher */}
            <div className="flex bg-white/10 backdrop-blur-xl border border-white/20 p-1 rounded-2xl shadow-inner">
              {['ku', 'ar', 'en'].map(l => (
                  <button 
                    key={l} 
                    onClick={() => setLanguage(l)} 
                    className={`
                      relative px-3 py-1.5 text-[10px] font-black rounded-xl transition-all duration-300
                      ${language === l 
                        ? 'bg-white text-teal-800 shadow-[0_0_15px_rgba(255,255,255,0.4)] scale-105 z-10' 
                        : 'text-white/60 hover:text-white hover:bg-white/5'
                      }
                    `}
                  >
                      {l.toUpperCase()}
                      {language === l && (
                        <span className="absolute -bottom-1 left-1/2 -translate-x-1/2 w-1 h-1 bg-teal-800 rounded-full"></span>
                      )}
                  </button>
              ))}
            </div>
          </div>
        </header>

        {/* Navigation */}
        <nav className="flex overflow-x-auto px-4 py-4 gap-2 no-scrollbar bg-white sticky top-0 z-10 shadow-sm border-b">
          {Object.keys(VIEW_CONFIG).map(v => (
            <button 
                key={v} onClick={() => { setCurrentView(v); setResponse(null); setQuery(''); setImageData(null); }}
                className={`flex-shrink-0 px-4 py-2 rounded-xl text-[10px] font-black transition-all flex items-center gap-2 ${currentView === v ? 'bg-teal-800 text-white shadow-md' : 'bg-gray-100 text-gray-500'}`}
            >
                <span>{VIEW_CONFIG[v].icon}</span> {t(VIEW_CONFIG[v].textKey)}
            </button>
          ))}
        </nav>

        {/* Content */}
        <main className="flex-grow p-4 space-y-6">
          
          {/* Drug View */}
          {currentView === 'drug' && (
            <div className="space-y-6 animate-in fade-in duration-500">
              <div className="bg-white rounded-[30px] p-6 shadow-sm border border-emerald-100 space-y-4">
                <div className="flex items-center gap-3 mb-2 border-b border-emerald-50 pb-3">
                  <span className="p-2 bg-emerald-100 text-emerald-600 rounded-xl">ğŸ”</span>
                  <h3 className="font-black text-emerald-800 text-sm">{t('drug_search_title')}</h3>
                </div>
                <input type="text" className="w-full p-4 bg-gray-50 rounded-2xl border-none font-bold shadow-inner" value={query} onChange={(e) => setQuery(e.target.value)} placeholder={t('placeholder_drug')} />
                <button onClick={() => handleAIService('drug')} className="w-full py-4 bg-emerald-500 text-white rounded-2xl font-black text-xs">{language === 'ku' ? 'Ø¯Û†Ø²ÛŒÙ†Û•ÙˆÛ•ÛŒ Ø²Ø§Ù†ÛŒØ§Ø±ÛŒ Ø¯Û•Ø±Ù…Ø§Ù† âœ¨' : language === 'ar' ? 'Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¯ÙˆØ§Ø¡ âœ¨' : 'Find Drug Info âœ¨'}</button>
              </div>

              <div className="bg-white rounded-[30px] p-6 shadow-sm border border-sky-100 space-y-4">
                <div className="flex items-center gap-3 mb-2 border-b border-sky-50 pb-3">
                  <span className="p-2 bg-sky-100 text-sky-600 rounded-xl">ğŸ“¸</span>
                  <h3 className="font-black text-sky-800 text-sm">{t('drug_rx_title')}</h3>
                </div>
                <label className="block w-full py-8 bg-sky-50 text-sky-700 rounded-3xl border-2 border-dashed border-sky-200 cursor-pointer text-center">
                  {imageData ? (language === 'ku' ? "ÙˆÛÙ†Û•Ú©Û• Ø¦Ø§Ù…Ø§Ø¯Û•ÛŒÛ• âœ…" : language === 'ar' ? "Ø§Ù„ØµÙˆØ±Ø© Ø¬Ø§Ù‡Ø²Ø© âœ…" : "Image ready âœ…") : t('rx_prompt')}
                  <input type="file" accept="image/*" className="hidden" onChange={handleFile} />
                </label>
                {imageData && <button onClick={() => handleAIService('drug_rx')} className="w-full py-4 bg-sky-600 text-white rounded-2xl font-black text-xs">{language === 'ku' ? 'Ø´ÛŒÚ©Ø±Ø¯Ù†Û•ÙˆÛ•ÛŒ Ú•Û•Ú†Û•ØªÛ• Ø¨Û• AI' : language === 'ar' ? 'ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø±ÙˆØ´ØªØ© Ø¨Ù€ AI' : 'Analyze Rx with AI'}</button>}
              </div>

              <div className="bg-white rounded-[30px] p-6 shadow-sm border border-amber-100 text-center space-y-4">
                <div className="flex items-center gap-3 mb-2 border-b border-amber-50 pb-3">
                  <span className="p-2 bg-amber-100 text-amber-600 rounded-xl">ğŸ“</span>
                  <h3 className="font-black text-amber-800 text-sm">{t('drug_pharmacy_title')}</h3>
                </div>
                <p className="text-[11px] font-bold text-gray-500 p-4 bg-amber-50/50 rounded-2xl">{t('pharmacy_status')}</p>
              </div>
            </div>
          )}

          {/* Lab View */}
          {currentView === 'lab' && (
            <div className="space-y-6 animate-in fade-in duration-500">
              <div className="bg-white rounded-[30px] p-6 shadow-sm border border-indigo-100 space-y-4">
                <div className="flex items-center gap-3 mb-2 border-b border-indigo-50 pb-3">
                  <span className="p-2 bg-indigo-100 text-indigo-600 rounded-xl">ğŸ”¬</span>
                  <h3 className="font-black text-indigo-800 text-sm">{t('lab_analyze_title')}</h3>
                </div>
                <label className="block w-full py-8 bg-indigo-50 text-indigo-700 rounded-3xl border-2 border-dashed border-indigo-200 cursor-pointer hover:bg-indigo-100 transition-colors text-center">
                  {imageData ? (
                    <div className="space-y-2">
                      <span className="text-2xl">âœ…</span>
                      <p className="font-black text-[10px]">{language === 'ku' ? 'ÙˆÛÙ†Û•ÛŒ ÙÛ•Ø­Ø³Û•Ú©Û• Ø¦Ø§Ù…Ø§Ø¯Û•ÛŒÛ•' : language === 'ar' ? 'ØµÙˆØ±Ø© Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø¬Ø§Ù‡Ø²Ø©' : 'Lab image ready'}</p>
                    </div>
                  ) : (
                    <div className="space-y-2">
                      <span className="text-3xl">ğŸ“„</span>
                      <p className="font-black text-[10px]">{t('lab_prompt')}</p>
                    </div>
                  )}
                  <input type="file" accept="image/*" className="hidden" onChange={handleFile} />
                </label>
                <button 
                  onClick={() => handleAIService('lab')} 
                  className="w-full py-4 bg-indigo-600 text-white rounded-2xl font-black text-xs shadow-lg active:scale-95 transition-transform"
                >
                  {language === 'ku' ? 'Ø´ÛŒÚ©Ø±Ø¯Ù†Û•ÙˆÛ•ÛŒ Ø¦Û†ØªÛ†Ù…Ø§ØªÛŒÚ©ÛŒ ÙÛ•Ø­Ø³ ğŸ¤–' : language === 'ar' ? 'ØªØ­Ù„ÙŠÙ„ Ø§Ù„ØªØ­Ø§Ù„ÙŠÙ„ Ø¢Ù„ÙŠØ§Ù‹ ğŸ¤–' : 'Auto Lab Analysis ğŸ¤–'}
                </button>
              </div>

              <div className="bg-white rounded-[30px] p-6 shadow-sm border border-purple-100 text-center space-y-4">
                <div className="flex items-center gap-3 mb-2 border-b border-purple-50 pb-3 text-right">
                  <span className="p-2 bg-purple-100 text-purple-600 rounded-xl">ğŸ“</span>
                  <h3 className="font-black text-purple-800 text-sm">{t('lab_address_title')}</h3>
                </div>
                <p className="text-[11px] font-bold text-gray-500 leading-relaxed bg-purple-50/50 p-4 rounded-2xl border border-purple-50">
                  {t('lab_address_status')}
                </p>
              </div>
            </div>
          )}

          {/* Doctors View */}
          {currentView === 'doctors' && (
            <div className="space-y-6 animate-in fade-in duration-500">
              <div className="bg-white rounded-[30px] p-6 shadow-sm border border-rose-100 space-y-4">
                <div className="flex items-center gap-3 mb-2 border-b border-rose-50 pb-3">
                  <span className="p-2 bg-rose-100 text-rose-600 rounded-xl">ğŸ”</span>
                  <h3 className="font-black text-rose-800 text-sm">{t('docs_search_title')}</h3>
                </div>
                <input type="text" className="w-full p-4 bg-gray-50 rounded-2xl border-none font-bold" placeholder={t('docs_placeholder')} />
                <button className="w-full py-4 bg-rose-500 text-white rounded-2xl font-black text-xs">{t('docs_btn')}</button>
              </div>

              <div className="bg-white rounded-[30px] p-6 shadow-sm border border-sky-100 space-y-4">
                <div className="flex items-center gap-3 mb-2 border-b border-sky-50 pb-3">
                  <span className="p-2 bg-sky-100 text-sky-600 rounded-xl text-xl">ğŸ‘¶ğŸ©º</span>
                  <h3 className="font-black text-sky-800 text-sm">{t('docs_online_title')}</h3>
                </div>
                <div className="bg-gray-50 rounded-2xl p-4 min-h-[200px] max-h-[300px] overflow-y-auto space-y-3 no-scrollbar border border-gray-100">
                  {chatHistory.map((chat, i) => (
                    <div key={i} className={`flex ${chat.role === 'user' ? 'justify-end' : 'justify-start'}`}>
                      <div className={`max-w-[85%] p-3 rounded-2xl text-[11px] font-bold shadow-sm ${chat.role === 'user' ? 'bg-sky-500 text-white rounded-tr-none' : 'bg-white text-gray-700 rounded-tl-none border border-sky-50'}`}>
                        {chat.text}
                      </div>
                    </div>
                  ))}
                  {loading && <div className="text-[10px] font-bold text-gray-400 animate-pulse">{language === 'ku' ? 'Ø¯Ú©ØªÛ†Ø± ÙˆÛ•ÚµØ§Ù… Ø¯Û•Ø¯Ø§ØªÛ•ÙˆÛ•...' : language === 'ar' ? 'Ø§Ù„Ø·Ø¨ÙŠØ¨ ÙŠØ¬ÙŠØ¨...' : 'Doctor is replying...'}</div>}
                </div>
                <div className="flex gap-2">
                  <input type="text" className="flex-grow p-4 bg-gray-100 rounded-2xl border-none font-bold text-xs" value={query} onChange={(e) => setQuery(e.target.value)} placeholder={language === 'ku' ? 'Ù„ÛØ±Û• Ø¨Ù†ÙˆÙˆØ³Û•...' : language === 'ar' ? 'Ø§ÙƒØªØ¨ Ù‡Ù†Ø§...' : 'Write here...'} onKeyPress={(e) => e.key === 'Enter' && handleAIService('doctors_ai')} />
                  <button onClick={() => handleAIService('doctors_ai')} className="p-4 bg-sky-600 text-white rounded-2xl shadow-md active:scale-90 transition-transform">ğŸ“¤</button>
                </div>
              </div>

              <div className="bg-white rounded-[30px] p-6 shadow-sm border border-gray-100 text-center space-y-2">
                <h3 className="font-black text-gray-800 text-sm">{t('docs_booking_title')}</h3>
                <p className="text-[10px] font-bold text-gray-400">{t('docs_booking_status')}</p>
              </div>
            </div>
          )}

          {/* Pregnancy View */}
          {currentView === 'pregnancy' && (
            <div className="space-y-6 animate-in fade-in duration-500">
              <div className="bg-white rounded-[35px] p-6 shadow-md border border-amber-100 space-y-6">
                <div className="text-center space-y-2">
                  <h3 className="font-black text-gray-800 text-sm">{language === 'ku' ? 'Ø¨Û•Ø´ÛŒ Ø®Ø²Ù…Û•ØªÚ¯ÙˆØ²Ø§Ø±ÛŒ Ø¯ÙˆÙˆÚ¯ÛŒØ§Ù†ÛŒ (AI)' : language === 'ar' ? 'Ù‚Ø³Ù… Ø®Ø¯Ù…Ø§Øª Ø§Ù„Ø­Ù…Ù„ (AI)' : 'Pregnancy Service (AI)'}</h3>
                  <p className="text-[10px] text-gray-400 font-bold">{language === 'ku' ? 'ØªÚ©Ø§ÛŒÛ• Ú•ÛÚ©Û•ÙˆØªÛŒ Ú©Û†ØªØ§ Ø³ÙˆÙˆÚ•ÛŒ Ù…Ø§Ù†Ú¯Ø§Ù†Û•Øª Ù„ÛØ±Û• Ø¯ÛŒØ§Ø±ÛŒ Ø¨Ú©Û•' : language === 'ar' ? 'ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ ØªØ§Ø±ÙŠØ® Ø¢Ø®Ø± Ø¯ÙˆØ±Ø© Ø´Ù‡Ø±ÙŠØ© Ù‡Ù†Ø§' : 'Please select your LMP date here'}</p>
                </div>
                
                <div className="relative">
                  <input 
                    type="date" 
                    className="w-full p-5 bg-gray-50 rounded-[25px] border-none font-bold shadow-inner text-center text-teal-700 appearance-none" 
                    value={query} 
                    onChange={(e) => setQuery(e.target.value)} 
                  />
                  {!query && (
                    <div className="absolute inset-0 flex items-center justify-center pointer-events-none text-gray-400 font-bold text-xs">
                      {t('preg_date_placeholder')}
                    </div>
                  )}
                </div>

                <div className="grid grid-cols-1 gap-4">
                  <button onClick={() => handleAIService('pregnancy_weeks')} className="flex items-center justify-between px-6 py-4 bg-amber-500 text-white rounded-2xl font-black text-xs shadow-lg active:scale-95 transition-transform">
                    <span className="flex items-center gap-2">ğŸ“… {t('preg_weeks_btn')}</span>
                    <span className="text-xs">ğŸ¤–</span>
                  </button>
                  <button onClick={() => handleAIService('pregnancy_gender')} className="flex items-center justify-between px-6 py-4 bg-pink-500 text-white rounded-2xl font-black text-xs shadow-lg active:scale-95 transition-transform">
                    <span className="flex items-center gap-2">ğŸ§¬ {t('preg_gender_btn')}</span>
                    <span className="text-xs">âœ¨</span>
                  </button>
                </div>
              </div>

              <div className="p-4 bg-blue-50/50 rounded-2xl border border-blue-100 flex items-start gap-3">
                <span className="text-xl">ğŸ’¡</span>
                <p className="text-[10px] font-bold text-blue-800 leading-relaxed">
                  {language === 'ku' ? 'Ø²ÛŒØ±Û•Ú©ÛŒ Ø¯Û•Ø³ØªÚ©Ø±Ø¯ Ø¨Û• Ø´ÛÙˆÛ•ÛŒÛ•Ú©ÛŒ Ø¦Û†ØªÛ†Ù…Ø§ØªÛŒÚ©ÛŒ ØªÛ•Ù…Û•Ù†ÛŒ Ù…Ù†Ø¯Ø§ÚµØŒ Ú©Ø§ØªÛŒ Ù„Û•Ø¯Ø§ÛŒÚ©Ø¨ÙˆÙˆÙ† Ùˆ Ú•ÛÙ†Ù…Ø§ÛŒÛŒ Ú•Û•Ú¯Û•Ø² Ù‡Û•Ú˜Ù…Ø§Ø± Ø¯Û•Ú©Ø§Øª.' : language === 'ar' ? 'Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ ÙŠØ­Ø³Ø¨ Ø¹Ù…Ø± Ø§Ù„Ø¬Ù†ÙŠÙ†ØŒ Ù…ÙˆØ¹Ø¯ Ø§Ù„ÙˆÙ„Ø§Ø¯Ø© ÙˆØªÙˆØ¬ÙŠÙ‡Ø§Øª Ø§Ù„Ø¬Ù†Ø³ Ø¢Ù„ÙŠØ§Ù‹.' : 'AI automatically calculates fetal age, delivery date, and gender guidance.'}
                </p>
              </div>
            </div>
          )}

          {/* Donation View */}
          {currentView === 'donation' && (
            <div className="space-y-6 animate-in fade-in duration-500">
              <div className="bg-white rounded-[35px] p-8 shadow-md border border-red-100 text-center space-y-6">
                <div className="p-4 bg-red-50 rounded-full w-20 h-20 flex items-center justify-center mx-auto mb-2">
                    <span className="text-4xl">â¤ï¸</span>
                </div>
                
                <h2 className="text-xl font-black text-gray-800">{t('tab_donation')}</h2>
                
                <div className="space-y-4 text-right px-2">
                    <p className="text-sm font-bold text-gray-700 leading-relaxed">
                        {language === 'ku' ? 'Ø¨Û† ÛŒØ§Ø±Ù…Û•ØªÛŒØ¯Ø§Ù†ÛŒ Ù†Û•Ø®Û†Ø´ÛŒÛŒÛ• Ø¯Ø±ÛÚ˜Ø®Ø§ÛŒÛ•Ù†Û•Ú©Ø§Ù† Ùˆ Ù‡Ø§ÙˆÚ©Ø§Ø±ÛŒÚ©Ø±Ø¯Ù†ÛŒ Ø¦Ø§Ø±Û•Ø²ÙˆÙˆÙ…Û•Ù†Ø¯Ø§Ù†Û•.' : language === 'ar' ? 'Ù„Ù…Ø³Ø§Ø¹Ø¯Ø© Ø§Ù„Ù…Ø±Ø¶Ù‰ Ø°ÙˆÙŠ Ø§Ù„Ø£Ù…Ø±Ø§Ø¶ Ø§Ù„Ù…Ø²Ù…Ù†Ø© ÙˆØ§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø© Ø§Ù„ØªØ·ÙˆØ¹ÙŠØ©.' : 'To help chronic patients and voluntary assistance.'}
                    </p>
                    
                    <div className="p-6 bg-gray-50 rounded-[25px] border border-red-50 space-y-3">
                        <p className="text-xs font-black text-red-600">{language === 'ku' ? 'Ø¨Û† ÛŒØ§Ø±Ù…Û•ØªÛŒØ¯Ø§Ù† Ù„Û• Ú•ÛÚ¯Û•ÛŒ FIB:' : language === 'ar' ? 'Ù„Ù„Ù…Ø³Ø§Ø¹Ø¯Ø© Ø¹Ø¨Ø± FIB:' : 'To help via FIB:'}</p>
                        <div className="text-lg font-black text-teal-700 tracking-wider">
                            07503055949
                        </div>
                    </div>
                </div>

                <div className="bg-red-500/10 p-4 rounded-2xl">
                    <p className="text-[10px] font-bold text-red-700">{language === 'ku' ? 'Ø¨Û•Ø®Ø´ÛŒÙ†Û•Ú©Û•Øª Ø¯Û•Ø¨ÛØªÛ• Ù‡Û†Ú©Ø§Ø±ÛŒ Ú•Ø²Ú¯Ø§Ø±Ú©Ø±Ø¯Ù†ÛŒ Ú˜ÛŒØ§Ù†ÛŒ Ú©Û•Ø³ÛÚ©.' : language === 'ar' ? 'ØªØ¨Ø±Ø¹Ùƒ Ø³ÙŠÙƒÙˆÙ† Ø³Ø¨Ø¨Ø§Ù‹ Ù„Ø¥Ù†Ù‚Ø§Ø° Ø­ÙŠØ§Ø© Ø´Ø®Øµ Ù…Ø§.' : 'Your donation will be a reason to save someone\'s life.'}</p>
                </div>
              </div>

              <div className="bg-white rounded-[30px] p-6 shadow-sm border border-gray-100">
                <p className="text-[10px] font-bold text-gray-500 mb-4 text-center">{language === 'ku' ? 'Ù¾Ø±Ø³ÛŒØ§Ø±ÛÚ©Øª Ù‡Û•ÛŒÛ• Ø¯Û•Ø±Ø¨Ø§Ø±Û•ÛŒ Ø¨Û•Ø®Ø´ÛŒÙ†ØŸ' : language === 'ar' ? 'Ù‡Ù„ Ù„Ø¯ÙŠÙƒ Ø³Ø¤Ø§Ù„ Ø­ÙˆÙ„ Ø§Ù„ØªØ¨Ø±Ø¹ØŸ' : 'Have a question about donation?'}</p>
                <textarea className="w-full p-4 bg-gray-50 rounded-2xl border-none font-bold shadow-inner text-xs" rows="3" value={query} onChange={(e) => setQuery(e.target.value)} placeholder={language === 'ku' ? 'Ù„ÛØ±Û• Ø¨Ù†ÙˆÙˆØ³Û•...' : language === 'ar' ? 'Ø§ÙƒØªØ¨ Ù‡Ù†Ø§...' : 'Write here...'} />
                <button onClick={() => handleAIService('donation')} className="w-full mt-3 py-4 bg-red-500 text-white rounded-2xl font-black text-xs shadow-lg">{language === 'ku' ? 'Ù†Ø§Ø±Ø¯Ù†ÛŒ Ù¾Ø±Ø³ÛŒØ§Ø±' : language === 'ar' ? 'Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø³Ø¤Ø§Ù„' : 'Send Question'}</button>
              </div>
            </div>
          )}

          {/* QA View */}
          {currentView === 'qa' && (
            <div className="space-y-4 animate-in fade-in duration-500">
              <div className="bg-white rounded-[35px] p-6 shadow-md border border-gray-100">
                <textarea className="w-full p-5 bg-gray-50 rounded-[25px] border-none font-bold shadow-inner" rows="4" value={query} onChange={(e) => setQuery(e.target.value)} placeholder={t(VIEW_CONFIG[currentView].textKey)} />
                <button onClick={() => handleAIService(currentView)} className={`w-full mt-4 py-4 rounded-2xl text-white font-black shadow-lg ${VIEW_CONFIG[currentView].button}`}>{t(VIEW_CONFIG[currentView].textKey)}</button>
              </div>
            </div>
          )}

          {/* General Results Display */}
          {loading && (
            <div className="flex flex-col items-center justify-center p-10 animate-pulse">
                <div className="w-12 h-12 border-4 border-teal-200 border-t-teal-600 rounded-full animate-spin mb-4"></div>
                <p className="font-black text-teal-700 text-sm">{t('loading')}</p>
            </div>
          )}
          
          {response && (
            <div className="mt-4 p-6 bg-white border border-teal-50 rounded-[35px] shadow-xl animate-in slide-in-from-bottom-5 duration-500">
                <div className="flex items-center gap-2 mb-4 border-b border-gray-0 pb-2">
                    <span className="text-teal-500">âœ¨</span>
                    <span className="text-[10px] font-black text-gray-400 uppercase tracking-widest">{language === 'ku' ? 'ÙˆÛ•ÚµØ§Ù…ÛŒ Ø²ÛŒØ±Û•Ú©ÛŒ Ø¯Û•Ø³ØªÚ©Ø±Ø¯' : language === 'ar' ? 'Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ' : 'AI Response'}</span>
                </div>
                <p className="text-sm leading-relaxed text-gray-700 whitespace-pre-wrap font-medium">{response}</p>
            </div>
          )}

          {error && <div className="p-4 bg-red-50 text-red-600 rounded-2xl text-center text-xs font-bold border border-red-100">{error}</div>}
        </main>

        {/* Footer */}
        <footer className="p-8 text-center bg-gray-50 border-t border-gray-100 mt-auto">
            <div className="bg-white inline-flex items-center gap-4 px-4 py-2 rounded-full shadow-sm mb-4 border border-gray-100">
                <span className="text-[10px] font-black text-gray-400">{t('visitor_count_label')}</span>
                <span className="text-sm font-black text-teal-700">{visitorCount}</span>
            </div>
            <p className="text-[8px] text-gray-400 italic px-6 leading-tight">{t('disclaimer')}</p>
        </footer>
      </div>
    </div>
  );
}
